var directiveModule = angular.module('starter.directive', []);

//身份证验证
directiveModule.directive('personId', function () {
    return {
        require: "ngModel",
        restrict: 'A',
        link: function (scope, elm, attrs, ctrl) {
            ctrl.$parsers.unshift(function (value) {
                var REGEXP = '';

                switch(attrs.idtype){
                    case '居民身份证':
                        REGEXP = /^[1-9](\d{13}|\d{16})[\dx]$/g;
                        break;

                    case '中国护照':
                        REGEXP = /^(P\d{7}|G\d{8}|S\d{7,8}|D\d+|1[4,5]\d{7})$/g;
                        break;

                    case '军官证':
                        REGEXP = /^[0-9]{8}$/g;
                        break;

                    default:
                         REGEXP = /^[0-9]{8}$/g;
                };
                
                if( !value || REGEXP.test(value) ){
                    ctrl.$setValidity('ID', true);
                    ctrl.$invalid = false;
                    return value;
                }else{
                    ctrl.$invalid = true;
                    ctrl.$setValidity('ID', false);
                    return undefined;    
                };
            });
        }
    };
});

//地址验证
directiveModule.directive('checkAddress', function () {
    return {
        require: "ngModel",
        restrict: "A",
        link: function (scope, elm, attrs, ctrl) {
            ctrl.$parsers.unshift(function (value) {
                var REGEXP = /^[a-zA-Z0-9\u4e00-\u9fa5]+$/g;

                if( !value || REGEXP.test(value) ){
                    ctrl.$setValidity('address', true);
                    ctrl.$invalid = false;
                    return value;
                }else{
                    ctrl.$invalid = true;
                    ctrl.$setValidity('address', false);
                    return undefined;  
                };
            });
        }
    };
});

//数字验证
directiveModule.directive('number', function () {
    return {
        require: "ngModel",
        restrict: "A",
        link: function (scope, elm, attrs, ctrl) {
            ctrl.$parsers.unshift(function (value) {
                var REGEXP = /^\d+$/g;

                if( !value || REGEXP.test(value) ){
                    ctrl.$setValidity('numberCheck', true);
                    ctrl.$invalid = false;
                    return value;
                }else{
                    ctrl.$setValidity('numberCheck', false);
                    ctrl.$invalid = true;
                    return undefined;  
                };
            });
        }
    };
});

//邮编验证
directiveModule.directive('postalCode', function () {
    return {
        require: "ngModel",
        restrict: "A",
        link: function (scope, elm, attrs, ctrl) {
            ctrl.$parsers.unshift(function (value) {
                var REGEXP = /^[1-9]\d{5}(?!\d)$/g;

                if( !value || REGEXP.test(value) ){
                    ctrl.$setValidity('postal', true);
                    ctrl.$invalid = false;
                    return value;
                }else{
                    ctrl.$setValidity('postal', false);
                    ctrl.$invalid = true;
                    return undefined;  
                };
            });
        }
    };
});

directiveModule.directive('myrequired', function () {
    return {
        require: "ngModel",
        restrict: "A",
        link: function (scope, elm, attrs, ctrl) {
            ctrl.$invalid = true;
            ctrl.$parsers.unshift(function (value) {
                if(value == ''){
                    ctrl.$invalid = true;
                    return undefined;  
                }else{
                    $('#relationError p').addClass('ng-hide');
                    ctrl.$invalid = false;
                    return value;
                };
            });
        }
    };
});

//生日验证
directiveModule.directive('birthday', ['CommonFn', function (CommonFn) {
    return {
        restrict: "E",
        replace: true,
        templateUrl: 'templates/pad/datePickerTemplate.html',
        scope: {
            childScopeBirthday: '=parentScopeBirthay',
            childScopeAge: '=parentScopeAge',
            childScopeId: '=parentScopeId',
            childScopeIdCardPassDontPass: '=parentScopeIdCardPassDontPass',
            childScopeParentScopeFormPass: '=parentScopeFormPass',
            childScopeIdCardLongTime: '=parentScopeIdcardlongtime',
            childScopeAgePass: '=parentScopeAgepass',
            childScopeIdType: '=parentScopeIdtype'
        },
        link: function (scope, elm, attrs) {
            var button = elm.find('a');
            button.bind('click', function () {
                CommonFn.getDateFn(function (birthday) {
                    scope.childScopeBirthday = birthday;
                    scope.childScopeAge = CommonFn.birthdayToAgeFn(birthday);
                    if(scope.childScopeIdType != '居民身份证'){
                        scope.$apply(scope);
                        return;
                    };
                    if(scope.childScopeId){
                        if(CommonFn.getUserAge(scope.childScopeId).birthday != scope.childScopeBirthday){
                            scope.childScopeIdCardPassDontPass = true;
                        }
                    };
                    if(scope.childScopeAge < 1){
                        scope.childScopeAgePass = false;
                        scope.childScopeParentScopeFormPass = false;
                    }else{
                        if(scope.childScopeAge > 46){
                            scope.childScopeIdCardLongTime = true;
                        };
                        scope.childScopeAgePass = true;
                    };
                    
                    scope.$apply(scope);
                });
            });
        }
    };
}]);

//电话号码验证
directiveModule.directive('phoneNumber', function () {
    return {
        require: "ngModel",
        restrict: "A",
        link: function (scope, elm, attrs, ctrl) {
            ctrl.$parsers.unshift(function (value) {
                var REGEXP = /(^[0-9]{3,4}\-[0-9]{7,8}$)|(^[0-9]{7,8}$)|(^\([0-9]{3,4}\)[0-9]{3,8}$)|(^0{0,1}13[0-9]{9}$)|(13\d{9}$)|(15[0135-9]\d{8}$)|(18[267]\d{8}$)/g;

                if( !value || REGEXP.test(value) ){
                    ctrl.$setValidity('phone', true);
                    ctrl.$invalid = false;
                    return value;
                }else{
                    ctrl.$setValidity('phone', false);
                    ctrl.$invalid = true;
                    return undefined;  
                };
            });
        }
    };
});